<div class="topline">
  <a href="https://wa.me/51970766227" target="_blank" rel="noopener noreferrer" class="topline-link">
    <i class="bi bi-whatsapp"></i>
    <span>Contáctanos</span>
  </a>
</div>

<mat-toolbar class="app-navbar">
  <a routerLink="/" class="navbar-brand-button">
    <img src="assets/img/logocrisol.png" alt="Logo de la Librería" class="navbar-logo-image">
  </a>

  <span class="navbar-center-spacer-left"></span>
  <span class="navbar-center-spacer-right"></span>

  <div class="navbar-right-section">
    <ng-container *ngIf="(isLoggedIn$ | async) === false">
      <button mat-button routerLink="/login" class="navbar-nav-button icon-button">
        <i class="bi bi-person navbar-nav-icon"></i>
        <span class="icon-button-text">Ingresar</span>
      </button>
    </ng-container>

    <ng-container *ngIf="(isLoggedIn$ | async) === true">
      <button mat-button
              [matMenuTriggerFor]="userOptionsMenu"
              #userOptionsTrigger="matMenuTrigger"
              (mouseenter)="userOptionsTrigger.openMenu()"
              class="navbar-nav-button icon-button">
        <i class="bi bi-person-fill navbar-nav-icon"></i>
        <span class="icon-button-text">Hola, {{ (currentUser$ | async)?.nombres }}</span>
      </button>

      <mat-menu #userOptionsMenu="matMenu" (mouseleave)="userOptionsTrigger.closeMenu()" class="app-menu-panel">
        <div (mouseleave)="userOptionsTrigger.closeMenu()">
          
          <button mat-menu-item routerLink="/mi-lista-deseos" class="app-menu-item">
            <i class="bi bi-heart-fill app-menu-item-icon"></i> Mi Lista de Deseos
          </button>

          <button mat-menu-item routerLink="/mis-pedidos" class="app-menu-item">
            <i class="bi bi-receipt-fill app-menu-item-icon"></i> Mis Pedidos
          </button>

          <button mat-menu-item *ngIf="isAdmin$ | async" routerLink="/admin" class="app-menu-item">
            <i class="bi bi-gear-fill app-menu-item-icon"></i> Admin
          </button>

          <button mat-menu-item (click)="logout()" class="app-menu-item">
            <i class="bi bi-box-arrow-right app-menu-item-icon"></i> Cerrar Sesión
          </button>
        </div>
      </mat-menu>
    </ng-container>

    <button mat-button routerLink="/carrito"
            [matBadge]="cartItemCount$ | async"
            [matBadgeHidden]="(cartItemCount$ | async) === 0"
            matBadgeColor="warn"
            matBadgePosition="above after"
            class="navbar-nav-button icon-button">
      <i class="bi bi-cart-fill navbar-nav-icon"></i>
      <span class="icon-button-text">Carrito</span>
    </button>
  </div>
</mat-toolbar>

<div class="main-content">
  <div class="product-detail-container">
    <div *ngIf="loading" class="loading-spinner">
      <mat-spinner></mat-spinner>
      <p>Cargando detalles del libro...</p>
    </div>
    
    <div *ngIf="errorMessage && !loading" class="error-message">
      <p>{{ errorMessage }}</p>
      <button mat-raised-button color="warn" routerLink="/">Volver a la lista</button>
    </div>

    <mat-card *ngIf="product$ | async as product; else loadingOrError" class="product-detail-card">
      <div class="product-content">
        
        <div class="product-image-section">
          <img [src]="product.imagenUrl || 'https://placehold.co/400x600/E0E0E0/212121?text=Sin+Portada'" 
               [alt]="'Portada de ' + product.titulo" 
               class="product-detail-image">
        </div>

        <div class="product-info-section">
          <h2 class="product-detail-title">{{ product.titulo }}</h2>
          <p class="product-detail-author"><strong>Autor:</strong> {{ product.autor }}</p>
          <p class="product-detail-category"><strong>Categoría:</strong> {{ product.categoria.nombre }}</p>
          <p class="product-detail-isbn"><strong>ISBN:</strong> {{ product.isbn }}</p>
          <p class="product-detail-price"><strong>Precio:</strong> {{ product.precio | currency:'S/.':'symbol':'1.2-2' }}</p>
          
          <p class="product-detail-stock" 
             [ngClass]="{'low-stock': product.stock <= 5 && product.stock > 0, 'no-stock': product.stock === 0}">
            <strong>Stock:</strong> {{ product.stock === 0 ? 'Agotado' : product.stock }}
          </p>
          
          <div class="product-detail-sinopsis-section">
            <div class="sinopsis-header">
              <h3>Sinopsis:</h3>
              <button mat-icon-button 
                      (click)="speakProductDetails(product)" 
                      [color]="chatbotService.isSpeaking ? 'warn' : 'primary'"
                      [attr.aria-label]="chatbotService.isSpeaking ? 'Detener lectura' : 'Escuchar detalles del producto'"
                      matTooltip="Escuchar detalles">
                <mat-icon *ngIf="!chatbotService.isSpeaking">volume_up</mat-icon>
                <mat-icon *ngIf="chatbotService.isSpeaking">stop_circle</mat-icon>
              </button>
            </div>
            <p class="product-detail-sinopsis">{{ product.sinopsis || 'Sinopsis no disponible.' }}</p>
          </div>

          <mat-card-actions class="product-detail-actions">
            <button mat-raised-button color="primary" 
                    [disabled]="product.stock === 0" 
                    (click)="addToCart(product)">
              <mat-icon>add_shopping_cart</mat-icon> Añadir al Carrito
            </button>

            <button mat-mini-fab color="warn" 
                    (click)="addToWishlist(product)" 
                    matTooltip="Añadir a Lista de Deseos" 
                    aria-label="Añadir a lista de deseos">
              <mat-icon>favorite</mat-icon>
            </button>

            <button mat-button routerLink="/">
              <mat-icon>arrow_back</mat-icon> Volver a la Lista
            </button>
          </mat-card-actions>

        </div>
      </div>
    </mat-card>

    <ng-template #loadingOrError>
      <div *ngIf="!loading && !errorMessage" class="no-content">
        <p>No se pudo cargar el libro.</p>
      </div>
    </ng-template>
  </div>
</div>

<footer class="app-footer">
  <div class="footer-content">
    <p>&copy; 2025 Librería Crisol. Todos los derechos reservados.</p>
    <div class="footer-social-icons">
      <a href="https://www.facebook.com/libreriascrisol.paginaoficial" target="_blank" class="social-icon" aria-label="Facebook">
        <i class="bi bi-facebook"></i>
      </a>
      <a href="https://twitter.com/LibreriasCrisol" target="_blank" class="social-icon" aria-label="Twitter">
        <i class="bi bi-twitter"></i>
      </a>
      <a href="https://www.instagram.com/libreriascrisol" target="_blank" class="social-icon" aria-label="Instagram">
        <i class="bi bi-instagram"></i>
      </a>
    </div>
  </div>
</footer>
